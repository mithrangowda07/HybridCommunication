{% extends "base.html" %}

{% block content %}
<div class="chat-container">
    <!-- Contacts Sidebar -->
    <div class="contacts-sidebar">
        <div class="p-3 border-bottom">
            <button type="button" class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#addContactModal">
                <i class="bi bi-person-plus"></i> Add Contact
            </button>
        </div>
        <div class="list-group list-group-flush" id="contacts-list">
            {% for contact in contacts %}
            <a href="#" class="list-group-item list-group-item-action contact-item" data-phone="{{ contact.contact_phone }}">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-1 contact-name">Loading...</h6>
                        <small class="text-body-secondary contact-phone">{{ contact.contact_phone }}</small>
                    </div>
                </div>
            </a>
            {% endfor %}
        </div>
    </div>

    <!-- Chat Main Area -->
    <div class="chat-main" id="chat-main">
        <div class="p-3 border-bottom d-flex justify-content-between align-items-center">
            <div>
                <h5 class="mb-0" id="current-chat-name">Select a contact</h5>
            </div>
        </div>
        <div class="chat-messages" id="chat-messages"></div>
        <div class="chat-input">
            <form id="message-form" class="d-none">
                <div class="input-group">
                    <label class="btn btn-outline-secondary" for="file-upload">
                        <i class="bi bi-paperclip"></i>
                    </label>
                    <input type="file" id="file-upload" class="d-none">
                    <input type="text" class="form-control" id="message-input" placeholder="Type a message...">
                    <button class="btn btn-primary" type="submit">
                        <i class="bi bi-send"></i>
                    </button>
                </div>
            </form>
            <div id="offline-message" class="text-center text-body-secondary">
                Select a contact to start messaging
            </div>
        </div>
    </div>
</div>

<!-- Add Contact Modal -->
<div class="modal fade" id="addContactModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Contact</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="add-contact-form">
                    <div class="mb-3">
                        <label for="contact-phone" class="form-label">Phone Number</label>
                        <input type="text" class="form-control" id="contact-phone" required
                               placeholder="Enter phone number with country code">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="add-contact-btn">Add Contact</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Initialize Socket.IO with reconnection options
    const socket = io({
        reconnection: true,
        reconnectionAttempts: Infinity,
        reconnectionDelay: 1000,
        reconnectionDelayMax: 5000
    });
    let currentContact = null;
    let lastMessageId = null;  // Track last message to prevent duplicates
    
    // Socket connection handlers
    socket.on('connect', function() {
        console.log('Connected to server');
    });
    
    socket.on('disconnect', function() {
        console.log('Disconnected from server');
    });

    // Handle incoming messages
    socket.on('new_message', function(data) {
        const message = data.message;
        if (currentContact && 
            (message.sender_phone === currentContact || message.receiver_phone === currentContact)) {
            appendMessage({
                id: message.id,
                content: message.content,
                timestamp: formatLocalTime(message.timestamp),
                is_sender: message.sender_phone === '{{ current_user.phone_number }}'
            });
        }
    });

    // Handle message status updates
    socket.on('message_status', function(data) {
        const messageElement = document.querySelector(`.message[data-message-id="${data.message_id}"]`);
        if (messageElement) {
            const statusElement = messageElement.querySelector('.message-status');
            if (statusElement) {
                updateMessageStatus(statusElement, data.status);
            }
        }
    });

    // Load contact details
    function loadContactDetails(contactItem) {
        const phone = contactItem.dataset.phone;
        fetch(`/get_contact_details/${phone}`)
            .then(response => response.json())
            .then(data => {
                const nameElement = contactItem.querySelector('.contact-name');
                nameElement.textContent = data.display_name;
            });
    }

    // Update all contact statuses
    function updateAllContactStatuses() {
        document.querySelectorAll('.contact-item').forEach(loadContactDetails);
    }

    // Set up periodic status updates
    setInterval(updateAllContactStatuses, 5000);

    // Handle contact selection
    document.querySelectorAll('.contact-item').forEach(item => {
        item.addEventListener('click', function() {
            const phone = this.dataset.phone;
            currentContact = phone;
            
            // Update UI
            document.querySelectorAll('.contact-item').forEach(i => i.classList.remove('active'));
            this.classList.add('active');
            
            const name = this.querySelector('.contact-name').textContent;
            document.getElementById('current-chat-name').textContent = name;
            
            // Show/hide appropriate elements
            document.getElementById('message-form').classList.remove('d-none');
            document.getElementById('offline-message').classList.add('d-none');
            
            // Load messages
            loadMessages(phone);
        });
        
        // Load initial contact details
        loadContactDetails(item);
    });

    // Load messages for a contact
    function loadMessages(phone) {
        fetch(`/get_messages/${phone}`)
            .then(response => response.json())
            .then(messages => {
                const chatMessages = document.getElementById('chat-messages');
                chatMessages.innerHTML = '';
                messages.forEach(message => {
                    message.timestamp = formatLocalTime(message.timestamp);
                    appendMessage(message);
                });
                chatMessages.scrollTop = chatMessages.scrollHeight;
            });
    }

    // Append a message to the chat
    function appendMessage(message) {
        // Prevent duplicate messages
        if (message.id === lastMessageId) {
            return;
        }
        lastMessageId = message.id;

        const chatMessages = document.getElementById('chat-messages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${message.is_sender ? 'message-sent' : 'message-received'}`;
        messageDiv.dataset.messageId = message.id;

        let content = message.content;
        if (message.is_file) {
            if (message.file_type === 'image') {
                content = `<img src="/uploads/${message.content}" class="img-fluid" alt="Image">`;
            } else {
                content = `<a href="/uploads/${message.content}" target="_blank" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-file-earmark"></i> ${message.file_name || message.content}
                          </a>`;
            }
        }

        messageDiv.innerHTML = `
            <div class="message-content">${content}</div>
            <div class="message-time">
                ${message.timestamp}
            </div>
        `;
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Get status icon based on message status
    function getStatusIcon(status) {
        switch(status) {
            case 'sending':
                return '<i class="bi bi-clock" title="Sending..."></i>';
            case 'sent':
                return '<i class="bi bi-check" title="Sent"></i>';
            case 'delivered':
                return '<i class="bi bi-check-all" title="Delivered"></i>';
            case 'read':
                return '<i class="bi bi-check-all text-primary" title="Read"></i>';
            case 'failed':
                return '<i class="bi bi-exclamation-circle text-danger" title="Failed to send"></i>';
            default:
                return '<i class="bi bi-clock" title="Sending..."></i>';
        }
    }

    // Convert UTC to local time
    function formatLocalTime(timestamp) {
        const date = new Date(timestamp.replace(' ', 'T') + 'Z');
        return date.toLocaleString();
    }

    // Update message status indicator
    function updateMessageStatus(statusElement, status) {
        statusElement.innerHTML = getStatusIcon(status);
    }

    // Handle message sending
    document.getElementById('message-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const input = document.getElementById('message-input');
        const message = input.value.trim();
        
        if (message && currentContact) {
            socket.emit('send_message', {
                receiver_phone: currentContact,
                message: message
            });
            
            input.value = '';
        }
    });

    // Handle file upload
    document.getElementById('file-upload').addEventListener('change', function(e) {
        if (!currentContact) return;
        
        const file = e.target.files[0];
        if (!file) return;
        
        const formData = new FormData();
        formData.append('file', file);
        formData.append('receiver_phone', currentContact);
        
        fetch('/upload_file', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('File uploaded successfully');
                // Clear the file input
                this.value = '';
            } else {
                alert(data.message);
            }
        });
    });

    // Handle adding new contacts
    document.getElementById('add-contact-btn').addEventListener('click', function() {
        const phone = document.getElementById('contact-phone').value.trim();
        
        fetch('/add_contact', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `phone_number=${encodeURIComponent(phone)}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.message);
            }
        });
    });
</script>
{% endblock %} 